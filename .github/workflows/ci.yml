name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4

      - name: Start MinIO
        run: |
          docker run -d --name minio -p 9000:9000 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio server /data
          for i in $(seq 1 30); do
            curl -sf http://localhost:9000/minio/health/live && break
            sleep 1
          done

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true
          working-directory: bench-new/orchestrator

      - name: Create MinIO Bucket
        run: |
          docker run --rm --network host --entrypoint /bin/sh minio/mc -c \
            "mc alias set myminio http://localhost:9000 minioadmin minioadmin && mc mb myminio/railsbencher-results --ignore-existing"

      - name: Orchestrator Unit Tests
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/orchestrator_test
          QUEUE_DATABASE_URL: postgres://postgres:postgres@localhost:5432/orchestrator_test
          RAILS_ENV: test
          PARALLEL_WORKERS: 1
          S3_ENDPOINT: http://localhost:9000
          S3_UPLOAD_ENDPOINT: http://localhost:9000
          S3_DOWNLOAD_ENDPOINT: http://localhost:9000
        run: |
          cd bench-new/orchestrator
          bin/rails db:create db:schema:load
          bin/rails db:schema:load:queue || true
          bin/rails test

      - name: Task Runner Tests
        env:
          MOCK_ALWAYS_SUCCEED: "1"
        run: |
          cd bench-new/task-runner
          bundle install
          bundle exec ruby -Ilib/ruby -Itest -e 'Dir["test/**/*_test.rb"].each { |f| require "./#{f}" }'

  integration-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install fish and jq
        run: sudo apt-get update && sudo apt-get install -y fish jq

      - name: Start Services
        run: ./test/orchestrator/setup.sh

      - name: Run API Tests
        run: ./test/orchestrator/api_tests.sh

      - name: Run API Lifecycle Test
        run: ./bench-new/orchestrator/test/integration/api_lifecycle_test.sh

      - name: Show Logs on Failure
        if: failure()
        run: docker compose -f bench-new/orchestrator/docker-compose.yml logs

  e2e-jobs-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Start Services
        run: ./test/orchestrator/setup.sh

      - name: Run E2E Tests (Background Jobs)
        run: ./test/orchestrator/e2e_tests.sh

      - name: Run Task Runner E2E Integration Test
        run: ./test/integration/task_runner_e2e_test.sh

      - name: Show Logs on Failure
        if: failure()
        run: docker compose -f bench-new/orchestrator/docker-compose.yml logs

  e2e-full-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Fish Shell and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y fish jq

      - name: Install gum
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt update && sudo apt install -y gum

      - name: Full E2E with Mock Benchmark
        run: |
          fish bench-new/master/run.fish \
            -c bench-new/config/ci.json \
            --local-orchestrator \
            --mock \
            --non-interactive

      - name: Verify Results
        run: |
          echo "=== Results Directory ==="
          ls -la results/
          echo "=== Finding output files ==="
          find results -name "output.txt" -exec echo "Found: {}" \; -exec cat {} \;

  terraform-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Validate Infrastructure Configs
        run: |
          cd bench-new/infrastructure/meta
          terraform init -backend=false
          terraform validate

  site-generator:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run Site Generator Integration Test
        run: ./test/integration/site_generator_test.sh
