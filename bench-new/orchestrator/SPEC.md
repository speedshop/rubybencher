### Orchestrator (Ruby HTTP service + Postgres)

The orchestrator has a few roles:

1. Display an HTML interface to humans to allow them to monitor the status of the run and take actions.
2. Coordinate with benchmark runner instances to claim tasks, receive heartbeats, receive benchmark results, error logs.
3. Gzip all results when done.

It will use Postgres for all data, in a container on the orchestrator host.

It will use Ruby on Rails.

It will have it's own test suite using Minitest.

Task claims (see later for more details) will be resolved with optimistic database locking. Note that task runners can only fulfill tasks which match their provider and instance type.

The orchestrator will also automatically mark tasks as failed if the heartbeat fails to report.

The orchestrator has a button to "end a run early", which causes the final gzip file to be created before all tasks have finished, and causes all tasks not yet in progress/claimed to be deleted.

#### Orchestrator API Specification

##### Authentication

All API endpoints (except the HTML dashboard) require an `Authorization: Bearer <API_KEY>` header. The API key is generated by Terraform and provided to task runners via userdata/cloud-init.

##### Endpoints

###### POST `/run/start`

**Purpose**: Receive instance type configuration from master script and create tasks. Creates a "run".

**Request Body**:
```json
{
  "ruby_version": "3.4.7",
  "runs_per_instance_type": 3,
  "aws": ["c8g.medium", "c7g.medium"],
  "azure": ["Standard_D2pls_v6"]
}
```

**Response** (201 Created):
```json
{
  "run_id": 1733945123,
  "tasks_created": 9,
  "tasks": [
    {"id": 1, "provider": "aws", "instance_type": "c8g.medium", "run": 1, "status": "pending"},
    {"id": 2, "provider": "aws", "instance_type": "c8g.medium", "run": 2, "status": "pending"}
  ]
}
```

**Errors**:
- 400: Invalid params (missing ruby_version, empty provider arrays, etc.)
- 409: A run is already in progress

###### POST `/tasks/claim`

**Purpose**: Task runner requests a task matching its provider/instance_type.

**Request Body**:
```json
{
  "provider": "aws",
  "instance_type": "c8g.medium",
  "runner_id": "i-0abc123def456"
}
```

**Response** (200 OK - task assigned):
```json
{
  "status": "assigned",
  "task": {
    "id": 42,
    "provider": "aws",
    "instance_type": "c8g.medium",
    "run": 2,
    "ruby_version": "3.4.7"
  },
  "presigned_urls": {
    "result": "https://s3.amazonaws.com/bucket/results/42/result.tar.gz?X-Amz-...",
    "error": "https://s3.amazonaws.com/bucket/results/42/error.tar.gz?X-Amz-..."
  }
}
```

**Response** (200 OK - no tasks available, but run not complete):
```json
{
  "status": "wait",
  "retry_after_seconds": 30
}
```

**Response** (200 OK - run complete, no more tasks):
```json
{
  "status": "done"
}
```

**Errors**:
- 400: Missing provider or instance_type
- 404: No run in progress

**Notes**: Uses optimistic locking - if two runners claim simultaneously, one gets the task, the other gets `wait` or another task.

###### POST `/tasks/:id/heartbeat`

**Purpose**: Task runner reports progress on a claimed task.

**Request Body**:
```json
{
  "runner_id": "i-0abc123def456",
  "status": "running",
  "current_benchmark": "optcarrot",
  "progress_pct": 45,
  "message": "Running optcarrot benchmark"
}
```

**Valid `status` values**:
- `boot` - Instance started, task runner initializing
- `provision` - Pulling docker image, setting up environment
- `running` - Benchmark in progress
- `uploading` - Uploading results to S3
- `finished` - Complete (use `/complete` instead)
- `error` - Failed (use `/fail` instead)

**Response** (200 OK):
```json
No response body
```

**Errors**:
- 400: Missing task_id or status
- 404: Task not found
- 409: Task not claimed by this runner (runner_id mismatch)

###### POST `/tasks/:id/complete`

**Purpose**: Task runner marks a task as successfully completed.

**Request Body**:
```json
{
  "runner_id": "i-0abc123def456",
  "s3_result_key": "results/42/result.tar.gz",
}
```

**Response** (200 OK):
```
No response body
```

**Errors**:
- 400: Missing required fields
- 404: Task not found
- 409: Task not claimed by this runner

###### POST `/tasks/:id/fail`

**Purpose**: Task runner marks a task as failed. Failed tasks are not automatically retried.

**Request Body**:
```json
{
  "runner_id": "i-0abc123def456",
  "error_type": "benchmark_crash",
  "error_message": "Segmentation fault in optcarrot",
  "s3_error_key": "results/42/error.tar.gz",
  "debug_mode": false
}
```

**Response** (200 OK):
```json
No response body
```

**Errors**:
- 400: Missing required fields
- 404: Task not found
- 409: Task not claimed by this runner

###### GET `/run`

**Purpose**: Get current run status (used by master script polling). Returns result gzip URL when run is complete.

**Response** (200 OK - run in progress):
```json
{
  "run_id": 1733945123,
  "status": "running",
  "ruby_version": "3.4.7",
  "created_at": "2024-12-11T10:30:00Z",
  "tasks": {
    "total": 33,
    "pending": 12,
    "claimed": 3,
    "completed": 15,
    "failed": 3
  },
  "gzip_url": null
}
```

**Response** (200 OK - run complete):
```json
{
  "run_id": 1733945123,
  "status": "complete",
  "ruby_version": "3.4.7",
  "created_at": "2024-12-11T10:30:00Z",
  "completed_at": "2024-12-11T14:45:00Z",
  "tasks": {
    "total": 33,
    "pending": 0,
    "claimed": 0,
    "completed": 30,
    "failed": 3
  },
  "gzip_url": "https://s3.amazonaws.com/bucket/runs/1733945123/results.tar.gz?X-Amz-..."
}
```

**Response** (404 - no run):
```json
No response body
```

###### POST `/run/stop`

**Purpose**: End the run early (from dashboard button). Creates gzip from completed results, deletes unclaimed tasks.

**Request Body**:
```json
None
```

**Response** (200 OK):
```json
None
```

**Errors**:
- 404: No run in progress

###### GET `/` (HTML Dashboard)

**Purpose**: Human-readable dashboard showing run status.

**Response**: HTML page displaying:
- Current run status (idle/running/complete)
- Task summary counts by status
- Task breakdown by provider/instance_type
- Live task list with heartbeat status
- "End Run Early" button
- Link to download final gzip (when complete)

Uses Turbo and Hotwire for a frontend framework.

##### Background Jobs

###### Heartbeat Timeout Checker

- Runs every 60 seconds
- Marks tasks as `failed` if no heartbeat received in 2 minutes
- Failed tasks are not re-queued (no automatic retries)

###### Gzip Builder

- Triggered when all tasks are `completed` or `failed`
- Downloads all `result.tar.gz` files from S3
- Repackages into single `results.tar.gz` with structure: `<instance_type>-<run>/output.txt`
- Uploads to S3 and updates run status with `gzip_url`
