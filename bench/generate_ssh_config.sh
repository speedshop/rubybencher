#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TF_DIR="${ROOT_DIR}/terraform"
OUT_FILE="${ROOT_DIR}/ssh_config"

if ! command -v jq >/dev/null 2>&1; then
  echo "jq is required to generate the SSH config" >&2
  exit 1
fi

if ! command -v terraform >/dev/null 2>&1; then
  echo "terraform is required to read outputs" >&2
  exit 1
fi

outputs="$(terraform -chdir="${TF_DIR}" output -json)"

aws_bastion_public_ip="$(jq -r '.aws_bastion_public_ip.value // empty' <<<"${outputs}")"
azure_bastion_public_ip="$(jq -r '.azure_bastion_public_ip.value // empty' <<<"${outputs}")"
key_path="${TF_DIR}/bench-key.pem"

if [[ -z "${aws_bastion_public_ip}" && -z "${azure_bastion_public_ip}" ]]; then
  echo "No bastion IPs found in terraform outputs. Did you run terraform apply?" >&2
  exit 1
fi

all_instance_ips="$(jq -r '.all_instance_ips.value' <<<"${outputs}")"
instance_providers="$(jq -r '.instance_providers.value' <<<"${outputs}")"
ssh_users="$(jq -r '.ssh_user.value' <<<"${outputs}")"

sanitize() {
  echo "$1" | tr '._' '-' | tr -c 'A-Za-z0-9-_' '-'
}

cat >"${OUT_FILE}" <<EOF
# Autogenerated by bench/generate_ssh_config.sh
Host *
  ServerAliveInterval 30
  StrictHostKeyChecking no
  UserKnownHostsFile /dev/null

EOF

if [[ -n "${aws_bastion_public_ip}" ]]; then
  cat >>"${OUT_FILE}" <<EOF
Host bastion-aws
  HostName ${aws_bastion_public_ip}
  User ec2-user
  IdentityFile ${key_path}

EOF
fi

if [[ -n "${azure_bastion_public_ip}" ]]; then
  cat >>"${OUT_FILE}" <<EOF
Host bastion-azure
  HostName ${azure_bastion_public_ip}
  User azureuser
  IdentityFile ${key_path}

EOF
fi

jq -r 'to_entries[] | "\(.key) \(.value)"' <<<"${all_instance_ips}" | while read -r name ip; do
  [[ -z "${ip}" ]] && continue
  provider="$(jq -r --arg k "${name}" '.[$k]' <<<"${instance_providers}")"
  user="$(jq -r --arg p "${provider}" '.[$p]' <<<"${ssh_users}")"
  host_alias="bench-$(sanitize "${name}")"
  bastion_host="bastion-${provider}"

  cat >>"${OUT_FILE}" <<EOF
Host ${host_alias}
  HostName ${ip}
  User ${user}
  IdentityFile ${key_path}
  ProxyJump ${bastion_host}

EOF
done

echo "Wrote SSH config to ${OUT_FILE}"
echo "Usage: ssh -F ${OUT_FILE} bench-<instance>"
