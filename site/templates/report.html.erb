<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruby Benchmark Results</title>
  <script src="/js/d3.v7.min.js" defer></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body {
      overflow-x: hidden;
      max-width: 100%;
    }
    body {
      font-family: 'Iowan Old Style', 'Palatino Linotype', 'URW Palladio L', P052, serif;
      font-weight: normal;
      font-size: 12px;
      line-height: 1.4;
      color: #333;
      padding: 20px;
    }
    h1 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    h2 { font-size: 13px; font-weight: 600; margin: 0 0 8px 0; color: #555; }
    p.subtitle { color: #666; }
    .summary {
      display: flex;
      gap: 24px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .summary-item { font-size: 11px; }
    .summary-item strong { font-weight: 600; }
    .summary-item .arch { color: #888; font-size: 10px; }
    .summary-item .fastest { color: #2a2; }
    .summary-item .slower { color: #888; }

    .main-layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }
    .left-column {
      width: 570px;
      max-width: 100%;
      flex-shrink: 0;
      margin-bottom: 16px;
    }
    .left-column p {
      margin-bottom: 8px;
    }
    .right-column {
      flex: 1;
      min-width: 0;
      max-width: 100%;
    }

    @media (max-width: 999px) {
      .main-layout {
        flex-direction: column;
      }
      .left-column {
        width: 100%;
      }
      .right-column {
        width: 100%;
      }
      .benchmark-cell {
        width: 125px;
        max-width: calc(50% - 2px);
        height: auto;
      }
    }

    #beeswarm-matrix {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
    }
    .benchmark-cell {
      display: block;
    }
    .benchmark-cell.svg-highlight {
      background: #fff3cd;
    }
    .benchmark-label {
      font-size: 8px;
      fill: #666;
      text-anchor: middle;
    }
    .dot {
      stroke: none;
      opacity: 0.7;
      cursor: pointer;
    }
    .dot.dimmed { opacity: 0.1; }
    .dot.highlighted { opacity: 1; stroke: #333; stroke-width: 0.5px; }
    .axis text { font-size: 7px; fill: #999; }

    .instance-legend {
      display: flex;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 10px;
      min-height: 18px;
    }
    .instance-legend span {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .instance-legend .swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .table-container {
      overflow-x: auto;
    }
    table {
      min-width: 100%;
      border-collapse: collapse;
      font-size: 10px;
    }
    th, td {
      padding: 3px 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #ddd;
      position: sticky;
      top: 0;
      background: white;
    }
    .time-cell {
      font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
      text-align: right;
      font-size: 9px;
      padding: 3px 4px;
    }
    .instance-cell.table-highlight { background: #fff3cd !important; }
    .ci-cell {
      font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
      text-align: right;
      font-size: 8px;
      color: #999;
      padding: 3px 4px;
    }
    .rel-cell {
      font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
      text-align: right;
      font-size: 8px;
      font-weight: 500;
      padding: 3px 4px;
    }
    .na { color: #ccc; }
    tr.all-row td {
      background: #f0f4f8;
      font-weight: 600;
    }
    tr.all-row td.time-cell,
    tr.all-row td.ci-cell,
    tr.all-row td.rel-cell {
      background: #f0f4f8;
    }
    .benchmark-name {
      cursor: pointer;
    }
    .benchmark-name:hover {
      background: #f0f0f0;
    }
    .benchmark-name a {
      color: inherit;
      text-decoration: none;
    }
    .benchmark-name a:hover {
      text-decoration: underline;
    }
    tr.all-row .benchmark-name:hover {
      background: #e0e4e8;
    }
    .instance-cell {
      cursor: pointer;
    }
    th.instance-group {
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    th.sub-header {
      font-size: 8px;
      font-weight: 500;
      color: #888;
      padding: 2px 4px;
      text-align: right;
    }
    .col-divider {
      border-left: 1px solid #ddd;
    }

    .color-legend {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 9px;
      color: #666;
      margin-top: 8px;
    }
    .color-legend-bar {
      width: 100px;
      height: 8px;
      border-radius: 2px;
    }

    #filter {
      padding: 3px 6px;
      border: 1px solid #ddd;
      border-radius: 3px;
      font-size: 10px;
      width: 100%;
      margin-bottom: 6px;
    }

    .tooltip {
      position: absolute;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 10px;
      pointer-events: none;
      z-index: 100;
    }

    .summary-beeswarm {
      width: 100%;
      max-width: 100%;
      height: 62px;
      margin-bottom: 16px;
      overflow-x: auto;
    }
    .summary-beeswarm svg {
      width: 100%;
      display: block;
    }
    .mobile-legend {
      display: none;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 10px;
      min-height: 18px;
    }
    .mobile-legend span {
      display: flex;
      align-items: center;
      gap: 3px;
    }
    .mobile-legend .swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    @media (max-width: 999px) {
      .mobile-legend {
        display: flex;
      }
    }
  </style>
</head>
<body>
  <div class="left-column">
    <h1>The Great Cross-Cloud Ruby Benchmark</h1>
    <p class="subtitle">Comparing iteration times across <%= instance_names.size %> machine types on several public clouds. Each dot is one non-warmup iteration.</p>
    <p>This site was borne of my continuous frustration at <a href="https://speedshop.co">Speedshop</a> of clients running on old generation AWS instances, when I knew "free speed" was on the table. This page simply runs <a href="https://github.com/ruby/ruby-bench">ruby-bench</a>, a series of <i>mostly</i> CPU-bound benchmarks maintained by Ruby core and the YJIT developers.</p>
    <p>All benchmarks are run with YJIT enabled on Ruby <%= ruby_version %>. View the code for this page <a href="https://github.com/speedshop/rubybencher">here.</a></p>
  </div>

  <div class="mobile-legend" id="mobile-legend"></div>
  <div class="summary-beeswarm" id="summary-beeswarm"></div>

  <div class="main-layout">
    <div class="left-column">
      <input type="text" id="filter" placeholder="Filter benchmarks...">
      <div class="color-legend">
        <span>0%</span>
        <div class="color-legend-bar" id="color-legend-bar"></div>
        <span>300%+</span>
        <span style="margin-left: 8px; color: #999;">(% slower than fastest)</span>
      </div>
      <div class="table-container">
        <table id="results-table">
          <thead>
            <tr>
              <th rowspan="2">Benchmark</th>
              <% instance_names.each do |instance| %>
              <th colspan="3" class="instance-group col-divider"><%= instance %></th>
              <% end %>
            </tr>
            <tr>
              <% instance_names.each do |instance| %>
              <th class="sub-header col-divider">ms</th>
              <th class="sub-header">±%</th>
              <th class="sub-header">vs best</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <tr class="all-row" data-name="all" data-benchmark="all">
              <td class="benchmark-name">all</td>
              <% instance_names.each do |instance| %>
              <%
                time = all_row[instance]
                relative = all_row[instance.to_s + "_relative"] || 0
              %>
              <td class="time-cell col-divider instance-cell" data-instance="<%= instance %>" data-benchmark="all">
                <%= time %>
              </td>
              <td class="ci-cell instance-cell" data-instance="<%= instance %>" data-benchmark="all"></td>
              <td class="rel-cell instance-cell" data-instance="<%= instance %>" data-benchmark="all" data-relative="<%= relative %>">
                <% if relative > 0 %>+<%= relative %>%<% end %>
              </td>
              <% end %>
            </tr>
            <% table_data.each do |row| %>
            <%
              times = instance_names.map { |i| row[i] }.compact
              min_time = times.min
            %>
            <tr data-name="<%= row[:name].downcase %>" data-benchmark="<%= row[:name] %>">
              <td class="benchmark-name"><a href="https://github.com/ruby/ruby-bench/tree/main/benchmarks/<%= row[:name] %>" target="_blank"><%= row[:name] %></a></td>
              <% instance_names.each do |instance| %>
              <%
                time = row[instance]
                relative = row[instance.to_s + "_relative"] || 0
                ci = row[instance.to_s + "_ci"]
              %>
              <td class="time-cell col-divider instance-cell" data-instance="<%= instance %>" data-benchmark="<%= row[:name] %>">
                <% if time %><%= time %><% else %><span class="na">—</span><% end %>
              </td>
              <td class="ci-cell instance-cell" data-instance="<%= instance %>" data-benchmark="<%= row[:name] %>">
                <% if ci && ci > 0 %>±<%= ci %><% end %>
              </td>
              <td class="rel-cell instance-cell" data-instance="<%= instance %>" data-benchmark="<%= row[:name] %>" data-relative="<%= relative %>">
                <% if time && relative > 0 %>+<%= relative %>%<% end %>
              </td>
              <% end %>
            </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="right-column">
      <div class="instance-legend" id="legend"></div>
      <div id="beeswarm-matrix"></div>
    </div>
  </div>

  <div class="tooltip" id="tooltip" style="display:none"></div>

  <script type="module">
    const instances = <%= instance_names.to_json %>;
    const benchmarks = <%= all_benchmarks.to_json %>;

    const colors = {
      '<%= instance_names[0] %>': '#4e79a7',
      '<%= instance_names[1] %>': '#f28e2c',
      '<%= instance_names[2] %>': '#e15759',
      '<%= instance_names[3] %>': '#76b7b2'
    };

    const tooltipEl = document.getElementById('tooltip');

    // Color scale for relative percentages (green = 0%, red = 300%+)
    const colorScale = d3.scaleLinear()
      .domain([0, 50, 150, 300])
      .range(['#22863a', '#6a9f3d', '#d9822b', '#cb2431'])
      .clamp(true);

    // Apply colors to relative percentages (runs immediately, no data needed)
    document.querySelectorAll('.rel-cell[data-relative]').forEach(el => {
      const rel = parseFloat(el.dataset.relative);
      if (rel > 0) {
        el.style.color = colorScale(rel);
      } else if (el.textContent.trim() === '') {
        // Leave empty cells unstyled
      } else {
        el.style.color = '#22863a';
      }
    });

    // Create gradient for legend bar
    const legendBar = document.getElementById('color-legend-bar');
    legendBar.style.background = `linear-gradient(to right, ${[0, 50, 150, 300].map(v => colorScale(v)).join(', ')})`;

    // Lookup maps (populated during render)
    const svgMap = {};      // svgMap[benchmark] = SVG element
    const dotMap = {};      // dotMap[benchmark][instance] = array of circle elements
    const tableMap = {};    // tableMap[benchmark][instance] = array of td elements
    let summaryLines = [];  // all summary line elements
    let allDots = [];       // flat array of all dots for legend highlight

    // Build tableMap from existing DOM
    benchmarks.forEach(b => { tableMap[b] = {}; instances.forEach(i => { tableMap[b][i] = []; }); });
    tableMap['all'] = {}; instances.forEach(i => { tableMap['all'][i] = []; });
    document.querySelectorAll('td.instance-cell').forEach(cell => {
      const { benchmark, instance } = cell.dataset;
      if (tableMap[benchmark]?.[instance]) tableMap[benchmark][instance].push(cell);
    });

    // Beeswarm parameters
    const cellWidth = 150;
    const cellHeight = 62;
    const cellPadding = 5;

    // Create placeholder SVGs and populate svgMap
    const container = d3.select('#beeswarm-matrix');
    benchmarks.forEach(benchmark => {
      const svg = container.append('svg')
        .attr('class', 'benchmark-cell')
        .attr('data-benchmark', benchmark)
        .attr('data-loaded', 'false')
        .attr('width', cellWidth)
        .attr('height', cellHeight)
        .attr('viewBox', `0 0 ${cellWidth} ${cellHeight}`)
        .attr('preserveAspectRatio', 'xMidYMid meet');
      svg.append('text')
        .attr('class', 'benchmark-label')
        .attr('x', cellWidth / 2)
        .attr('y', 11)
        .text(benchmark.length > 22 ? benchmark.slice(0, 20) + '…' : benchmark);
      svgMap[benchmark] = svg.node();
      dotMap[benchmark] = {};
      instances.forEach(i => { dotMap[benchmark][i] = []; });
    });

    // Highlight helpers using cached maps
    let currentHighlight = null;

    function highlightBeeswarm(benchmark, instance) {
      const svg = svgMap[benchmark];
      if (!svg) return;
      svg.classList.add('svg-highlight');
      if (instance) {
        instances.forEach(inst => {
          const dots = dotMap[benchmark][inst];
          const isTarget = inst === instance;
          dots.forEach(dot => {
            dot.classList.toggle('dimmed', !isTarget);
            dot.classList.toggle('highlighted', isTarget);
          });
        });
      } else {
        Object.values(dotMap[benchmark]).flat().forEach(dot => dot.classList.add('highlighted'));
      }
    }

    function highlightTableCells(benchmark, instance) {
      const cells = tableMap[benchmark]?.[instance];
      if (cells) cells.forEach(c => c.classList.add('table-highlight'));
    }

    function clearHighlights() {
      if (!currentHighlight) return;
      const { benchmark, instance } = currentHighlight;
      const svg = svgMap[benchmark];
      if (svg) {
        svg.classList.remove('svg-highlight');
        Object.values(dotMap[benchmark]).flat().forEach(dot => {
          dot.classList.remove('dimmed', 'highlighted');
        });
      }
      if (instance) {
        const cells = tableMap[benchmark]?.[instance];
        if (cells) cells.forEach(c => c.classList.remove('table-highlight'));
      }
      currentHighlight = null;
      tooltipEl.style.display = 'none';
    }

    // Legend highlight (all instances across all benchmarks)
    function highlightInstance(inst) {
      summaryLines.forEach(line => {
        const d = d3.select(line).datum();
        line.setAttribute('opacity', d.instance === inst ? 1 : 0.05);
        line.setAttribute('stroke-width', d.instance === inst ? 2 : 1);
      });
      allDots.forEach(dot => {
        const isTarget = dot.dataset.instance === inst;
        dot.classList.toggle('dimmed', !isTarget);
        dot.classList.toggle('highlighted', isTarget);
      });
    }

    function clearInstanceHighlight() {
      summaryLines.forEach(line => {
        line.setAttribute('opacity', 0.3);
        line.setAttribute('stroke-width', 1);
      });
      allDots.forEach(dot => {
        dot.classList.remove('dimmed', 'highlighted');
      });
    }

    // Build legend
    const legend = d3.select('#legend');
    const mobileLegend = d3.select('#mobile-legend');
    instances.forEach(inst => {
      [legend, mobileLegend].forEach(leg => {
        leg.append('span')
          .style('cursor', 'pointer')
          .html(`<span class="swatch" style="background:${colors[inst]}"></span>${inst}`)
          .on('pointerenter', () => highlightInstance(inst))
          .on('pointerleave', clearInstanceHighlight);
      });
    });

    // Table filter
    const filterInput = document.getElementById('filter');
    const tableRows = document.querySelectorAll('#results-table tbody tr');
    const beeswarmCells = Object.values(svgMap);
    filterInput.addEventListener('input', function() {
      const filter = this.value.toLowerCase();
      tableRows.forEach(row => {
        row.style.display = row.dataset.name.includes(filter) ? '' : 'none';
      });
      beeswarmCells.forEach(cell => {
        cell.style.display = cell.dataset.benchmark.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Event delegation for table
    const resultsTable = document.getElementById('results-table');
    resultsTable.addEventListener('pointerover', e => {
      const cell = e.target.closest('.instance-cell');
      const nameCell = e.target.closest('.benchmark-name');
      if (cell) {
        const { benchmark, instance } = cell.dataset;
        if (benchmark === 'all') return;
        clearHighlights();
        currentHighlight = { benchmark, instance };
        highlightTableCells(benchmark, instance);
        highlightBeeswarm(benchmark, instance);
      } else if (nameCell) {
        const benchmark = nameCell.closest('tr').dataset.benchmark;
        if (benchmark === 'all') return;
        clearHighlights();
        currentHighlight = { benchmark, instance: null };
        highlightBeeswarm(benchmark, null);
      }
    });
    resultsTable.addEventListener('pointerout', e => {
      const related = e.relatedTarget;
      if (!related || !resultsTable.contains(related)) {
        clearHighlights();
      }
    });

    // Event delegation for beeswarm matrix
    const beeswarmMatrix = document.getElementById('beeswarm-matrix');
    beeswarmMatrix.addEventListener('pointerover', e => {
      const dot = e.target.closest('.dot');
      if (!dot) return;
      const benchmark = dot.dataset.benchmark;
      const instance = dot.dataset.instance;
      const d = d3.select(dot).datum();
      clearHighlights();
      currentHighlight = { benchmark, instance };
      highlightBeeswarm(benchmark, instance);
      highlightTableCells(benchmark, instance);
      tooltipEl.style.display = 'block';
      tooltipEl.style.left = (e.pageX + 10) + 'px';
      tooltipEl.style.top = (e.pageY - 10) + 'px';
      tooltipEl.innerHTML = `${instance}: ${d.time}ms`;
    });
    beeswarmMatrix.addEventListener('pointerout', e => {
      const related = e.relatedTarget;
      if (!related || !beeswarmMatrix.contains(related)) {
        clearHighlights();
      }
    });

    // Fetch data and render charts
    let data = null;
    let byBenchmark = null;

    function renderBeeswarm(svg, benchmark) {
      if (svg.attr('data-loaded') === 'true') return;
      svg.attr('data-loaded', 'true');

      const benchData = byBenchmark.get(benchmark) || [];
      if (benchData.length === 0) return;

      const times = benchData.map(d => d.time);
      const xExtent = d3.extent(times);
      const xPadding = (xExtent[1] - xExtent[0]) * 0.1 || 10;
      const x = d3.scaleLinear()
        .domain([xExtent[0], xExtent[1] + xPadding])
        .range([cellPadding + 3, cellWidth - cellPadding]);

      const radius = 3;
      const centerY = cellHeight / 2 + 3;

      const sorted = [...benchData].sort((a, b) => a.time - b.time);
      const positions = [];
      sorted.forEach(d => {
        const px = x(d.time);
        let py = centerY;
        let dir = 1;
        let offset = 0;
        while (positions.some(p => Math.abs(p.x - px) < radius * 2 && Math.abs(p.y - py) < radius * 2)) {
          offset += radius * 2;
          py = centerY + offset * dir;
          dir *= -1;
          if (offset > 25) break;
        }
        d.px = px;
        d.py = Math.max(16, Math.min(cellHeight - 16, py));
        positions.push({x: px, y: d.py});
      });

      svg.append('g')
        .attr('class', 'axis')
        .attr('transform', `translate(0,${cellHeight - 12})`)
        .selectAll('text')
        .data(x.ticks(3))
        .enter().append('text')
        .attr('x', d => x(d))
        .attr('y', 8)
        .attr('text-anchor', 'middle')
        .text(d => d >= 1000 ? (d/1000).toFixed(1) + 's' : d + 'ms');

      svg.selectAll('.dot')
        .data(benchData)
        .enter().append('circle')
        .attr('class', 'dot')
        .attr('data-instance', d => d.instance)
        .attr('data-benchmark', benchmark)
        .attr('cx', d => d.px)
        .attr('cy', d => d.py)
        .attr('r', radius)
        .attr('fill', d => colors[d.instance])
        .each(function(d) {
          dotMap[benchmark][d.instance].push(this);
          allDots.push(this);
        });
    }

    function renderSummaryChart() {
      const summaryContainer = d3.select('#summary-beeswarm');
      const summaryWidth = summaryContainer.node().getBoundingClientRect().width || 800;
      const summaryHeight = 62;

      const byBench = d3.group(data, d => d.benchmark);
      const avgData = [];
      byBench.forEach((points, benchmark) => {
        const byInstance = d3.group(points, d => d.instance);
        const instanceAvgs = [];
        byInstance.forEach((instPoints, instance) => {
          instanceAvgs.push({ instance, avg: d3.mean(instPoints, d => d.time) });
        });
        const minAvg = d3.min(instanceAvgs, d => d.avg);
        instanceAvgs.forEach(({ instance, avg }) => {
          avgData.push({
            benchmark, instance,
            avgTime: Math.round(avg),
            relativePercent: ((avg / minAvg) - 1) * 100
          });
        });
      });

      const maxRelative = d3.max(avgData, d => d.relativePercent);
      const svg = summaryContainer.append('svg')
        .attr('width', summaryWidth)
        .attr('height', summaryHeight)
        .attr('viewBox', `0 0 ${summaryWidth} ${summaryHeight}`)
        .attr('preserveAspectRatio', 'xMidYMid meet');

      const x = d3.scaleLinear().domain([0, maxRelative]).range([5, summaryWidth - 5]);

      svg.append('g')
        .attr('class', 'axis')
        .attr('transform', `translate(0,${summaryHeight - 8})`)
        .selectAll('text')
        .data(x.ticks(10))
        .enter().append('text')
        .attr('x', d => x(d))
        .attr('y', 7)
        .attr('text-anchor', 'middle')
        .text(d => d + '%');

      svg.selectAll('.summary-line')
        .data(avgData)
        .enter().append('line')
        .attr('class', 'summary-line')
        .attr('x1', d => x(d.relativePercent))
        .attr('x2', d => x(d.relativePercent))
        .attr('y1', 4)
        .attr('y2', summaryHeight - 12)
        .attr('stroke', d => colors[d.instance])
        .attr('stroke-width', 1)
        .attr('opacity', 0.3)
        .each(function() { summaryLines.push(this); })
        .on('pointerenter', function(event, d) {
          this.setAttribute('opacity', 1);
          this.setAttribute('stroke-width', 2);
          tooltipEl.style.display = 'block';
          tooltipEl.style.left = (event.pageX + 10) + 'px';
          tooltipEl.style.top = (event.pageY - 10) + 'px';
          tooltipEl.innerHTML = `${d.instance}: ${d.avgTime}ms (+${d.relativePercent.toFixed(1)}%)<br><em>${d.benchmark}</em>`;
        })
        .on('pointerleave', function() {
          this.setAttribute('opacity', 0.3);
          this.setAttribute('stroke-width', 1);
          tooltipEl.style.display = 'none';
        });
    }

    // Fetch data, render summary immediately, lazy-load beeswarms
    fetch('/data.json')
      .then(r => r.json())
      .then(d => {
        data = d;
        byBenchmark = d3.group(data, d => d.benchmark);

        renderSummaryChart();

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              renderBeeswarm(d3.select(entry.target), entry.target.dataset.benchmark);
              observer.unobserve(entry.target);
            }
          });
        }, { rootMargin: '100px' });

        Object.values(svgMap).forEach(cell => observer.observe(cell));
      });
  </script>
</body>
</html>
