<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ruby Benchmark Results</title>
  <script>
    // Set base dynamically so production serves from /rubybench/ and local dev works at /
    (() => {
      const base = document.createElement('base');
      base.href = window.location.pathname.startsWith('/rubybench') ? '/rubybench/' : '/';
      document.head.appendChild(base);
    })();
  </script>
  <script src="js/d3.v7.min.js" defer></script>
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="css/report.css">
</head>
<body>
  <div class="intro-column">
    <h1>The Great Cross-Cloud Ruby Benchmark</h1>
    <p class="subtitle">Comparing iteration times across <%= instance_names.size %> machine types on several public clouds.</p>
    <p>This site was borne of my continuous frustration at <a href="https://speedshop.co">Speedshop</a> of clients running on old generation AWS instances, when I knew "free speed" was on the table if they just upgraded to a newer generation. However, I could never quantify the speed boost. This page simply runs <a href="https://github.com/ruby/ruby-bench">ruby-bench</a>, a series of <i>mostly</i> CPU-bound benchmarks maintained by Ruby core and the YJIT developers. We run across multiple instances to reduce the effect of noisy neighbors.</p>
    <p>For Rails apps, the most relevant benchmark is likely <code>shipit</code>. Keep in mind that this benchmark likely still overstates the performance difference because it runs the database in-memory, which makes the benchmark more CPU-bound than a real-world app with a real database.</p>
    <p>All benchmarks were run on <%= run_date %> with YJIT enabled on Ruby <%= ruby_version %>. View the code for this page <a href="https://github.com/speedshop/rubybencher">here.</a></p>
  </div>

  <div class="instance-legend" id="instance-legend">
    <%
      # Group instances by provider (first part of name before hyphen)
      grouped = instance_names.group_by { |name| name.split('-', 2).first }
    %>
    <% grouped.each_with_index do |(provider, instances), idx| %>
    <span class="provider-group" data-provider="<%= provider %>">
      <span class="provider-checkbox checked" data-provider="<%= provider %>">
        <span class="checkbox-visual"></span>
      </span>
      <span class="provider-name"><%= provider %>:</span>
      <% instances.each do |inst| %>
      <span class="instance-checkbox checked" data-instance="<%= inst %>">
        <span class="checkbox-visual"></span>
        <span class="instance-label"><%= inst.sub("#{provider}-", '') %></span>
      </span>
      <% end %>
    </span><% if idx < grouped.size - 1 %><span class="provider-divider">|</span><% end %>
    <% end %>
    <span class="legend-actions">
      <a href="#" id="select-all">select all</a> | <a href="#" id="deselect-all">deselect all</a>
    </span>
  </div>

  <div id="summary-chart"></div>
  <div id="tooltip"></div>

  <div class="main-layout">
    <div class="left-column">
      <input type="text" id="filter" placeholder="Filter benchmarks...">
      <div class="color-legend">
        <span>0%</span>
        <div class="color-legend-bar" id="color-legend-bar"></div>
        <span>300%+</span>
        <span style="margin-left: 8px; color: #999;">(% slower than fastest)</span>
      </div>
      <!-- Desktop table: benchmarks as rows, instances as columns -->
      <div class="table-wrapper desktop-table">
        <div class="top-scrollbar" id="top-scrollbar">
          <div class="top-scrollbar-inner" id="top-scrollbar-inner"></div>
        </div>
        <div class="table-container" id="table-container">
          <table id="results-table">
          <thead>
            <tr>
              <th rowspan="2">Benchmark</th>
              <% instance_names.each do |instance| %>
              <th colspan="3" class="instance-group col-divider"><%= instance %></th>
              <% end %>
            </tr>
            <tr>
              <% instance_names.each do |instance| %>
              <th class="sub-header col-divider">ms</th>
              <th class="sub-header">±%</th>
              <th class="sub-header">vs best</th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <tr class="all-row" data-name="all" data-benchmark="all">
              <td class="benchmark-name">all</td>
              <% instance_names.each do |instance| %>
              <%
                time = all_row[instance]
                relative = all_row[instance.to_s + "_relative"] || 0
              %>
              <td class="time-cell col-divider instance-cell" data-instance="<%= instance %>" data-benchmark="all">
                <%= time %>
              </td>
              <td class="ci-cell instance-cell" data-instance="<%= instance %>" data-benchmark="all"></td>
              <td class="rel-cell instance-cell" data-instance="<%= instance %>" data-benchmark="all" data-relative="<%= relative %>">
                <% if relative > 0 %>+<%= relative %>%<% end %>
              </td>
              <% end %>
            </tr>
            <% table_data.each do |row| %>
            <%
              times = instance_names.map { |i| row[i] }.compact
              min_time = times.min
            %>
            <tr data-name="<%= row[:name].downcase %>" data-benchmark="<%= row[:name] %>">
              <td class="benchmark-name"><a href="https://github.com/ruby/ruby-bench/tree/main/benchmarks/<%= row[:name] %>" target="_blank"><%= row[:name] %></a></td>
              <% instance_names.each do |instance| %>
              <%
                time = row[instance]
                relative = row[instance.to_s + "_relative"] || 0
                ci = row[instance.to_s + "_ci"]
              %>
              <td class="time-cell col-divider instance-cell" data-instance="<%= instance %>" data-benchmark="<%= row[:name] %>">
                <% if time %><%= time %><% else %><span class="na">—</span><% end %>
              </td>
              <td class="ci-cell instance-cell" data-instance="<%= instance %>" data-benchmark="<%= row[:name] %>">
                <% if ci && ci > 0 %>±<%= ci %><% end %>
              </td>
              <td class="rel-cell instance-cell" data-instance="<%= instance %>" data-benchmark="<%= row[:name] %>" data-relative="<%= relative %>">
                <% if time && relative > 0 %>+<%= relative %>%<% end %>
              </td>
              <% end %>
            </tr>
            <% end %>
          </tbody>
        </table>
        </div>
      </div>

      <!-- Mobile table: instances as rows, benchmarks as columns -->
      <div class="table-wrapper mobile-table">
        <div class="table-container">
          <table id="results-table-mobile">
          <thead>
            <tr>
              <th>Instance</th>
              <th class="col-divider">all</th>
              <% all_benchmarks.each do |benchmark| %>
              <th class="col-divider"><%= benchmark %></th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% instance_names.each do |instance| %>
            <tr data-instance="<%= instance %>">
              <td class="instance-name"><%= instance %></td>
              <%
                all_time = all_row[instance]
                all_relative = all_row[instance.to_s + "_relative"] || 0
              %>
              <td class="mobile-time-cell col-divider" data-relative="<%= all_relative %>">
                <span class="mobile-time"><%= all_time %></span>
                <span class="mobile-rel rel-cell" data-relative="<%= all_relative %>"><% if all_relative > 0 %>+<%= all_relative %>%<% end %></span>
              </td>
              <% table_data.each do |row| %>
              <%
                time = row[instance]
                relative = row[instance.to_s + "_relative"] || 0
                ci = row[instance.to_s + "_ci"]
              %>
              <td class="mobile-time-cell col-divider" data-relative="<%= relative %>">
                <% if time %>
                <span class="mobile-time"><%= time %></span>
                <span class="mobile-rel rel-cell" data-relative="<%= relative %>"><% if relative > 0 %>+<%= relative %>%<% end %></span>
                <% else %>
                <span class="na">—</span>
                <% end %>
              </td>
              <% end %>
            </tr>
            <% end %>
          </tbody>
        </table>
        </div>
      </div>
    </div>

  </div>

  <script>
    window.reportConfig = {
      instances: <%= instance_names.to_json %>,
      benchmarks: <%= all_benchmarks.to_json %>,
      summary: <%= summary.to_json %>
    };
  </script>
  <script type="module" src="js/report.js"></script>
</body>
</html>
